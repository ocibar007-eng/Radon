# Handoff 2026-01-25

## Escopo
- Blocos 7-10 (agentes core, comparacao, impressao, renderer, canonicalizer, self-healing, risk scoring, integracao E2E).
- Calculator com todas as formulas do compendio (78), incluindo Parte 2.
- Golden Set pipeline apontado para o orchestrator real quando RADON_PIPELINE_CMD nao existe.

## Resumo do que foi implementado hoje
- Calculator Python: todas as formulas do compendio implementadas e registradas no `FORMULAS`.
- Agents:
  - Clinical, Technical, Findings (ja existentes).
  - Comparison e Impression usando OpenAI Responses API.
- Orchestrator completo:
  - Gera ReportJSON, chama Comparison/Impression, renderiza Markdown final, canonicaliza, roda QA deterministico, self-healing (max 2 tentativas) e classifica risco S1/S2/S3.
- Renderer LLM:
  - Converte ReportJSON em laudo com regras de formato do prompt (separadores, titulos, uso de "â–º").
- Canonicalizer deterministico:
  - Normaliza quebras de linha, remove duplicatas, remove linhas vazias repetidas e aplica blacklist.
- Risk scorer:
  - Classifica S1/S2/S3 conforme QA e telemetria (latencia, auto-fix, <VERIFICAR>).
- Golden tests:
  - `scripts/golden/run_case_pipeline.ts` executa o pipeline real quando nao existe RADON_PIPELINE_CMD.
  - `scripts/golden/canonicalize.ts` passou a usar o canonicalizer da pipeline.
- Env:
  - `.env.example` atualizado com `OPENAI_MODEL_RENDERER`.

## Arquivos principais
- `services/calculator/formulas.py`
- `services/calculator/tests/test_formulas.py`
- `src/core/reportGeneration/orchestrator.ts`
- `src/core/reportGeneration/agents/impression.ts`
- `src/core/reportGeneration/agents/comparison.ts`
- `src/core/reportGeneration/renderer.ts`
- `src/core/reportGeneration/canonicalizer.ts`
- `src/core/reportGeneration/qa/self-healing.ts`
- `src/core/reportGeneration/qa/risk.ts`
- `src/types/report-json.ts`
- `scripts/golden/run_case_pipeline.ts`
- `scripts/golden/canonicalize.ts`

## Variaveis de ambiente
- `OPENAI_API_KEY`
- `OPENAI_MODEL_COMPARISON`
- `OPENAI_MODEL_IMPRESSION`
- `OPENAI_MODEL_RENDERER`

## Testes executados
- `services/calculator/venv/bin/python -m pytest services/calculator/tests/test_formulas.py`
- `npx vitest src/core/reportGeneration --run`

## Falhas conhecidas
- `npm test` falha por testes legados fora do escopo:
  - `src_backup_ui_refactor/...` (matcher `toBeInTheDocument` nao configurado no vitest).
  - `inbox/references/radon_v3_standalone/...` (mocks de Firebase).

## Notas importantes
- Algumas classificacoes clinicas sao simplificadas por limitacao de inputs:
  - Bosniak, PI-RADS, O-RADS, TI-RADS.
  - Se quiser fidelidade total, ajustar tabelas/regra clinica.

## Proximos passos sugeridos
- Implementar Oncology Agent (RECIST/iRECIST/Choi/Lugano) e integrar no orchestrator.
- Rodar `./scripts/run_golden_tests.sh` com chaves configuradas para validacao E2E real.
